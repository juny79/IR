# 체계적 최적화 전략 (Phase 2 기준)

## 현재 상황
- **Phase 2 (MAP 0.8470)**: Gemini HyDE + [6,3,1] + TopK=50 ← **최고 성능**
- **Phase 2.1 (MAP 0.8333)**: Gemini HyDE + [7,3,1] + TopK=40 ← 실패
- **Phase 3 (MAP 0.7992)**: Solar HyDE + [5,3,1] + TopK=50 ← 최악

## 전략 1: 투표 가중치 최적화 (우선순위: 높음)
**Phase 2 고정 + Weight만 변경**

| 테스트 | Weight | TopK | HyDE | 예상 시간 | 예상 MAP |
|--------|--------|------|------|-----------|----------|
| 2A | [6,4,2] | 50 | Gemini | 30분 | 0.85-0.86 |
| 2B | [8,3,1] | 50 | Gemini | 30분 | 0.84-0.85 |
| 2C | [6,3,2] | 50 | Gemini | 30분 | 0.85-0.86 |
| 2D | [5,4,2] | 50 | Gemini | 30분 | 0.85-0.86 |

**근거:**
- Rank 2의 가중치 증가 (3→4)가 효과적일 가능성
- Rank 3의 가중치 증가 (1→2)로 장거리 신호 활용
- [7,3,1]이 실패했으므로 Rank 1 과도 강화는 피함

## 전략 2: TopK 세밀 조정 (우선순위: 중간)
**Phase 2 고정 + TopK만 변경**

| 테스트 | Weight | TopK | HyDE | 예상 시간 | 예상 MAP |
|--------|--------|------|------|-----------|----------|
| 2E | [6,3,1] | 45 | Gemini | 30분 | 0.85-0.86 |
| 2F | [6,3,1] | 55 | Gemini | 30분 | 0.85-0.86 |
| 2G | [6,3,1] | 60 | Gemini | 30분 | 0.84-0.85 |

**근거:**
- TopK=40이 실패했으므로 45-60 범위 탐색
- TopK=50 주변에서 최적값 탐색

## 전략 3: HyDE 프롬프트 최적화 (우선순위: 높음)
**현재 Gemini HyDE 개선**

### 현재 프롬프트 분석 필요
```python
# models/llm_client.py의 HyDE 프롬프트 확인
```

### 개선 방향
1. **응답 길이 조정**: 현재 200자 → 150자 or 250자 테스트
2. **키워드 밀도**: "핵심 개념과 전문 용어를 포함하여" 추가
3. **자연스러운 언어**: "구어체로" → "문어체로" 변경 테스트

## 전략 4: Query Expansion (우선순위: 중간)
**동의어/유의어 추가로 검색 범위 확대**

```python
# 예: "광합성" → ["광합성", "엽록체", "클로로필", "이산화탄소 흡수"]
```

**구현 시간**: 2-3시간
**예상 개선**: +0.02 to +0.04 (MAP 0.86-0.88)

## 전략 5: Multi-Embedding (우선순위: 낮음)
**SBERT + Gemini + Upstage Embedding 앙상블**

**장점:**
- 실험 결과에서 5개 embedding 사용시 MAP 0.94 달성
- 다양한 semantic 표현 활용

**단점:**
- 인덱싱 시간: 2-3시간
- 복잡도 증가

**예상 개선**: +0.03 to +0.05 (MAP 0.88-0.90)

## Solar Pro 2 재시도에 대한 의견

### ❌ Solar Pro 2 리모델링 권장하지 않음

**이유:**
1. **검증된 실패**: Phase 3에서 MAP 0.7992 (-5.6%)
2. **기술적 언어 문제**: BM25 검색과 상충
3. **시간 낭비**: 리모델링에 수 시간 소요 + 실패 가능성 높음

**Solar Pro 2의 근본적 문제:**
```
Solar 출력 예시:
"광합성은 녹색식물, 조류, 일부 세균이 빛에너지를 화학에너지로 전환하여 
유기물(주로 포도당)을 합성하는 과정이다. 명반응에서는 엽록체의 틸라코이드 
막에서 빛에너지가 ATP와 NADPH로 전환되고, 암반응(캘빈 회로)에서는 
스트로마에서 RuBisCO 효소가 CO₂를 고정하여 글리세르알데하이드-3-인산(G3P)을 
생성한다..."

Gemini 출력 예시:
"광합성은 식물이 빛을 이용해 이산화탄소와 물로부터 포도당과 산소를 
만들어내는 과정입니다. 엽록체에서 일어나며, 명반응과 암반응의 
두 단계로 구성됩니다..."
```

Solar는 "RuBisCO 효소", "글리세르알데하이드-3-인산" 같은 전문 용어 사용
→ BM25는 정확한 키워드 매칭이 중요 → 일반 문서에 없는 용어 → 검색 실패

## 권장 실행 계획

### Phase 4: 체계적 미세 조정 (1-2일 소요)

**1단계: Weight 최적화** (오늘, 2시간)
```bash
# 테스트 2A, 2B, 2C 순차 실행
# 각 30분씩 총 1.5시간
```

**2단계: TopK 최적화** (내일, 2시간)
```bash
# 최적 Weight 선정 후
# TopK 45, 55, 60 테스트
```

**3단계: HyDE 프롬프트 개선** (내일, 3-4시간)
```bash
# 프롬프트 분석 및 수정
# A/B 테스트 3-4회
```

**4단계: Query Expansion** (필요시, 3-4시간)
```bash
# 동의어 사전 구축
# Expansion 로직 구현
```

**5단계: Multi-Embedding** (최후 수단, 3-4시간)
```bash
# Gemini + Upstage embedding 인덱싱
# 앙상블 검색 구현
```

## 예상 결과

**보수적 시나리오:**
- 1-2단계만 성공 → MAP 0.855-0.865 (+0.8% to +2.1%)

**낙관적 시나리오:**
- 1-3단계 성공 → MAP 0.865-0.880 (+2.1% to +3.9%)

**최적 시나리오:**
- 1-5단계 모두 성공 → MAP 0.880-0.900 (+3.9% to +6.3%)

## 다음 단계

**즉시 실행 (오늘):**
1. Weight [6,4,2] 테스트 → submission_11.csv
2. Weight [6,3,2] 테스트 → submission_12.csv
3. 최고 성능 선정 및 리더보드 제출

**내일 실행:**
1. TopK 세밀 조정
2. HyDE 프롬프트 분석 및 개선

**Solar Pro 2는 시도하지 않음** ← 검증된 실패 케이스
