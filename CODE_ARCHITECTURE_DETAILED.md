# IR ì‹œìŠ¤í…œ ì½”ë“œ êµ¬ì¡° - ìƒì„¸ ê°€ì´ë“œ

## ğŸ“ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IR í‰ê°€ ì‹œìŠ¤í…œ ì „ì²´ íë¦„                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  main.py    â”‚  â† ì‹œì‘ì : í‰ê°€ ë£¨í”„ ì‹¤í–‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ "í‰ê°€ ë°ì´í„°ì…‹" â†’ data/eval.jsonl
       â”‚ 220ê°œ ì§ˆë¬¸ ë°˜ë³µ
       â”‚
       â”œâ”€â†’ [ê° ì§ˆë¬¸ë§ˆë‹¤]
       â”‚
       â”œâ”€â†’ eval_rag.py
       â”‚   â””â”€ answer_question_optimized()
       â”‚      â”‚
       â”‚      â”œâ”€ (1) llm_client.analyze_query()
       â”‚      â”‚        â””â”€ Geminië¡œ ì¿¼ë¦¬ ë¶„ë¥˜
       â”‚      â”‚            â”œâ”€ ê³¼í•™ ì§ˆë¬¸? â†’ tool_calls ìƒì„±
       â”‚      â”‚            â””â”€ ë¹„ê³¼í•™ ì§ˆë¬¸? â†’ tool_calls ì—†ìŒ
       â”‚      â”‚
       â”‚      â”œâ”€ (2) solar_client.generate_hypothetical_answer()
       â”‚      â”‚        â””â”€ Solar Pro 2ë¡œ HyDE í™•ì¥
       â”‚      â”‚            (ìºì‹±: 80% ë¹„ìš© ì ˆê°)
       â”‚      â”‚
       â”‚      â”œâ”€ (3) run_hybrid_search()
       â”‚      â”‚        â”‚
       â”‚      â”‚        â”œâ”€ [Sparse ê²€ìƒ‰]
       â”‚      â”‚        â”‚  es_connector.search_sparse(hyde_query)
       â”‚      â”‚        â”‚  â””â”€ BM25ë¡œ Top 50 ë¬¸ì„œ ê²€ìƒ‰
       â”‚      â”‚        â”‚
       â”‚      â”‚        â”œâ”€ [Dense ê²€ìƒ‰ 1: SBERT]
       â”‚      â”‚        â”‚  embedding_client.get_query_embedding()
       â”‚      â”‚        â”‚  â””â”€ SBERTë¡œ ì¿¼ë¦¬ ì„ë² ë”© (ë¡œì»¬)
       â”‚      â”‚        â”‚
       â”‚      â”‚        â”œâ”€ [Dense ê²€ìƒ‰ 2: Gemini]
       â”‚      â”‚        â”‚  embedding_client.get_query_embedding(gemini=True)
       â”‚      â”‚        â”‚  â””â”€ Geminië¡œ ì¿¼ë¦¬ ì„ë² ë”© (ìºì‹±)
       â”‚      â”‚        â”‚
       â”‚      â”‚        â”œâ”€ [Hard Voting ìœµí•©]
       â”‚      â”‚        â”‚  hard_vote_results()
       â”‚      â”‚        â”‚  â””â”€ ì„¸ ê²€ìƒ‰ ê²°ê³¼ë¥¼ [5,4,2] ê°€ì¤‘ì¹˜ë¡œ í•©ì‚°
       â”‚      â”‚        â”‚
       â”‚      â”‚        â””â”€ [Reranker]
       â”‚      â”‚           reranker.rerank_documents()
       â”‚      â”‚           â””â”€ BAAIë¡œ Top 50ì„ ìµœì¢… ìˆœìœ„í™”
       â”‚      â”‚
       â”‚      â”œâ”€ (4) es_connector.get_document()
       â”‚      â”‚        â””â”€ Top 3 ë¬¸ì„œì˜ ë‚´ìš© ì¡°íšŒ
       â”‚      â”‚
       â”‚      â””â”€ (5) solar_client.generate_answer()
       â”‚             â””â”€ Solar Pro 2ë¡œ ìµœì¢… ë‹µë³€ ìƒì„±
       â”‚
       â””â”€â†’ submission.csvì— ê²°ê³¼ ì €ì¥ (ì‹¤ì‹œê°„)
           â”œâ”€ eval_id
           â”œâ”€ standalone_query
           â”œâ”€ topk [ë¬¸ì„œ5ê°œ]
           â””â”€ answer
```

---

## ğŸ“ íŒŒì¼ë³„ ìƒì„¸ ë¶„ì„

### 1ï¸âƒ£ main.py (ë©”ì¸ ì‹¤í–‰ íŒŒì¼)

```
ì—­í• : í‰ê°€ ë£¨í”„ ì „ì²´ ê´€ë¦¬
ìœ„ì¹˜: /root/IR/main.py
í¬ê¸°: ~70ì¤„

[ì£¼ìš” ë¡œì§]
â”œâ”€ submission.csv ì½ì–´ì„œ ì´ë¯¸ ì²˜ë¦¬ëœ ID í™•ì¸
â”œâ”€ data/eval.jsonlì—ì„œ 220ê°œ ì§ˆë¬¸ ë¡œë“œ
â”œâ”€ ê° ì§ˆë¬¸ë§ˆë‹¤:
â”‚  â”œâ”€ ì´ë¯¸ ì²˜ë¦¬ë¨? â†’ SKIP
â”‚  â””â”€ ë¯¸ì²˜ë¦¬? â†’ eval_rag.py í˜¸ì¶œ
â”œâ”€ ê²°ê³¼ë¥¼ submission.csvì— ì¦‰ì‹œ ì €ì¥
â””â”€ ì¤‘ë‹¨/ì¬ì‹œì‘ ê°€ëŠ¥ (ì´ë¯¸ ì²˜ë¦¬ëœ ë°ì´í„° ì œì™¸)

[ì…ë ¥]
data/eval.jsonl:
{
  "eval_id": 78,
  "msg": [{"role": "user", "content": "ë‚˜ë¬´ì˜ ë¶„ë¥˜ ë°©ë²•ì€?"}]
}

[ì¶œë ¥]
submission.csv (ì‹¤ì‹œê°„ ì¶”ê°€):
{
  "eval_id": 78,
  "standalone_query": "...",
  "topk": ["doc_id_1", ...],
  "answer": "..."
}

[íŠ¹ì§•]
âœ… ì‹¤ì‹œê°„ ì €ì¥ (ì¤‘ë‹¨í•´ë„ ì†ì‹¤ ì—†ìŒ)
âœ… ì´ë¯¸ ì²˜ë¦¬ëœ ë°ì´í„° ìë™ ì œì™¸
âœ… ì§„í–‰ ìƒí™© í‘œì‹œ [n/220]
```

---

### 2ï¸âƒ£ eval_rag.py (í•µì‹¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜)

```
ì—­í• : ê° ì§ˆë¬¸ì˜ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì²˜ë¦¬
ìœ„ì¹˜: /root/IR/eval_rag.py
í¬ê¸°: ~70ì¤„

[ì„¤ì •ê°’] â† ì´ íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´ ë™ì‘ ë³€ê²½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VOTING_WEIGHTS = [5, 4, 2]              â”‚ â† Hard Voting ê°€ì¤‘ì¹˜
â”‚ USE_MULTI_EMBEDDING = True              â”‚ â† SBERT + Gemini ì¡°í•©
â”‚ TOP_K_RETRIEVE = 60                     â”‚ â† ê²€ìƒ‰ í›„ë³´ ìˆ˜
â”‚ USE_RRF = False                         â”‚ â† Hard Voting ì‚¬ìš©
â”‚ USE_GATING = True                       â”‚ â† ê²Œì´íŒ… ì •ì±… ON/OFF
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ì£¼ìš” í•¨ìˆ˜: answer_question_optimized(messages)]

Step 1: ì¿¼ë¦¬ ë¶„ì„
â”œâ”€ llm_client.analyze_query(messages)
â”‚  â””â”€ Geminiê°€ tool_calls ìƒì„±í•˜ëŠ”ì§€ íŒë‹¨
â”‚     â”œâ”€ tool_calls ìˆìŒ: ê³¼í•™ ì§ˆë¬¸ â†’ ê²€ìƒ‰ í•„ìš”
â”‚     â””â”€ tool_calls ì—†ìŒ: ë¹„ê³¼í•™ ì§ˆë¬¸ â†’ ì¼ìƒ ëŒ€í™”
â””â”€ if tool_calls ìˆìŒ: ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

Step 2: HyDE í™•ì¥
â”œâ”€ solar_client.generate_hypothetical_answer(query)
â”‚  â””â”€ "ë‚˜ë¬´ì˜ ë¶„ë¥˜ëŠ”?" â†’ "ë‚˜ë¬´ëŠ” ì‹ë¬¼ì˜ ë¶„ë¥˜ ì²´ê³„ì—ì„œ..."
â””â”€ hyde_query = original_query + hypothetical_answer

Step 3: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰
â”œâ”€ run_hybrid_search(
â”‚     original_query=query,        # ì›ë³¸ ì¿¼ë¦¬
â”‚     sparse_query=hyde_query,     # Solar í™•ì¥ ì¿¼ë¦¬
â”‚     voting_weights=[5,4,2],      # ê°€ì¤‘ì¹˜
â”‚     top_k_retrieve=60            # TOP_K
â”‚  )
â””â”€ ìµœì¢… ìˆœìœ„ ê²°ê³¼ ë°›ìŒ

Step 4: ë¬¸ì„œ ë‚´ìš© ì¡°íšŒ
â”œâ”€ Top 3 ë¬¸ì„œì˜ ì‹¤ì œ ë‚´ìš© ì¡°íšŒ
â”‚  for docid in final_ranked_results[:3]:
â”‚      es.search(index="test", query={"term": {"docid": docid}})
â””â”€ context = ë¬¸ì„œë“¤ ë‚´ìš© í•©ì‚°

Step 5: ìµœì¢… ë‹µë³€ ìƒì„±
â”œâ”€ solar_client.generate_answer(messages, context)
â”‚  â””â”€ Solar Pro 2ê°€ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€ ìƒì„±
â””â”€ ìµœì¢… ê²°ê³¼ ë°˜í™˜

[ë°˜í™˜ê°’]
{
  "standalone_query": "ë‚˜ë¬´ì˜ ë¶„ë¥˜ ì²´ê³„",  # ì •ì œëœ ì¿¼ë¦¬
  "topk": ["doc_1", "doc_2", ...],       # Top 5 ë¬¸ì„œ
  "answer": "ë‚˜ë¬´ëŠ” ì‹ë¬¼ì˜ ë¶„ë¥˜..."       # ìƒì„±ëœ ë‹µë³€
}

[ë¹„ê³¼í•™ ì§ˆë¬¸ ì²˜ë¦¬]
else:  # tool_calls ì—†ìŒ (ë¹„ê³¼í•™ ì§ˆë¬¸)
  res["standalone_query"] = ""
  res["topk"] = []  # ë¹ˆ ë¦¬ìŠ¤íŠ¸ (ê²Œì´íŒ…)
  res["answer"] = analysis.content  # ì¼ìƒ ëŒ€í™” ì‘ë‹µ
```

**ì´ íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´**: ì „ì²´ ì‹œìŠ¤í…œì˜ ë™ì‘ì´ ë³€ê²½ë¨  
**ê°€ì¥ ìì£¼ ìˆ˜ì •ë˜ëŠ” íŒŒì¼**: ë§¤ ì‹¤í—˜ë§ˆë‹¤ ì„¤ì •ê°’ ë³€ê²½

---

### 3ï¸âƒ£ models/llm_client.py (ì¿¼ë¦¬ ë¶„ì„)

```
ì—­í• : Gemini APIë¡œ ì‚¬ìš©ì ì¿¼ë¦¬ ë¶„ì„
ìœ„ì¹˜: /root/IR/models/llm_client.py

[ì£¼ìš” ê¸°ëŠ¥]

llm_client = LLMClient()  # ì‹±ê¸€í†¤ íŒ¨í„´

def analyze_query(messages):
    """
    ë©”ì‹œì§€ë¥¼ Geminiì— ì „ë‹¬í•˜ì—¬ ë¶„ì„
    
    [ì‘ë™ ë°©ì‹]
    1. Gemini 2.5 Flash ëª¨ë¸ í˜¸ì¶œ
    2. tool_calls ìƒì„± íŒë‹¨
       â”œâ”€ ê³¼í•™ ì§ˆë¬¸: tool_calls ìƒì„±
       â”‚  {
       â”‚    "function": {"arguments": {"standalone_query": "..."}},
       â”‚    "tool_calls": True
       â”‚  }
       â””â”€ ë¹„ê³¼í•™ ì§ˆë¬¸: ì¼ë°˜ ì‘ë‹µ
          {
            "content": "ì•ˆë…•í•˜ì„¸ìš”!",
            "tool_calls": None
          }
    """

[íŠ¹ì§•]
âœ… ìºì‹± ë¯¸ì ìš© (ë§¤ë²ˆ ìƒˆë¡œìš´ API í˜¸ì¶œ)
âœ… ì „ ë°ì´í„°ë¥¼ ë³´ê³  íŒë‹¨ (ë§¥ë½ ì¸ì‹)
âœ… tool_calls í˜•ì‹: JSON êµ¬ì¡° + í•¨ìˆ˜ í˜¸ì¶œ
```

---

### 4ï¸âƒ£ models/solar_client.py (Solar Pro 2 HyDE & ë‹µë³€ ìƒì„±)

```
ì—­í• : Solar Pro 2 API í™œìš©
ìœ„ì¹˜: /root/IR/models/solar_client.py

[ì£¼ìš” ê¸°ëŠ¥]

solar_client = SolarClient()  # ì‹±ê¸€í†¤ íŒ¨í„´

1ï¸âƒ£ generate_hypothetical_answer(query)
   â”œâ”€ ìºì‹œ í™•ì¸
   â”‚  â””â”€ cache/hyde_cache.pklì—ì„œ ì¡°íšŒ
   â”œâ”€ ìºì‹œ ë¯¸ìŠ¤ ì‹œ
   â”‚  â””â”€ Upstage Solar Pro 2 API í˜¸ì¶œ
   â”‚     â””â”€ "queryì— ëŒ€í•œ ê°€ì„¤ì  ë‹µë³€ ìƒì„±"
   â”œâ”€ ìºì‹œì— ì €ì¥
   â”‚  â””â”€ pickle í˜•ì‹, 20ê°œë§ˆë‹¤ ìë™ ì €ì¥
   â””â”€ ê°€ì„¤ì  ë‹µë³€ ë°˜í™˜
      ì˜ˆ: "DNAì˜ êµ¬ì¡°?" â†’ "DNAëŠ” ì´ì¤‘ë‚˜ì„  êµ¬ì¡°ë¡œ..."

2ï¸âƒ£ generate_answer(messages, context)
   â”œâ”€ Upstage Solar Pro 2 API í˜¸ì¶œ
   â”‚  â”œâ”€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: context ê¸°ë°˜ ë‹µë³€ ìƒì„±
   â”‚  â””â”€ ì‚¬ìš©ì ë©”ì‹œì§€: ì›ë³¸ ì§ˆë¬¸
   â””â”€ ìµœì¢… ë‹µë³€ ìƒì„±
      â””â”€ context ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì •í™•í•œ ë‹µë³€

[ìºì‹± íš¨ê³¼]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì´ˆíšŒ: Upstage API í˜¸ì¶œ (10-20ì´ˆ)   â”‚
â”‚ ìºì‹œ: pickle ë¡œë“œ (<100ms)          â”‚
â”‚ ë‹¨ì¶•: 80~90% ì‹œê°„ ë° ë¹„ìš© ì ˆê°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ìºì‹± êµ¬ì¡°]
cache/
â””â”€ hyde_cache.pkl
   â”œâ”€ key: MD5(query)
   â””â”€ value: hypothetical_answer

[íŠ¹ì§•]
âœ… HyDE ìºì‹±: ê°™ì€ ì¿¼ë¦¬ ë°˜ë³µ ì‹¤í–‰ ì‹œ ë¹ ë¦„
âŒ ë‹µë³€ ìƒì„±ì€ ìºì‹± ë¯¸ì ìš© (ë§¥ë½ ë”°ë¼ ë‹¬ë¼ì§)
```

---

### 5ï¸âƒ£ models/embedding_client.py (ë‹¤ì¤‘ ì„ë² ë”©)

```
ì—­í• : SBERT + Gemini ì„ë² ë”© ê´€ë¦¬
ìœ„ì¹˜: /root/IR/models/embedding_client.py

[2ê°€ì§€ ì„ë² ë”© ëª¨ë¸]

1ï¸âƒ£ SBERT (ë¡œì»¬)
   - ëª¨ë¸: snunlp/KR-SBERT-V40K-klueNLI-augSTS
   - ì°¨ì›: 768
   - íŠ¹ì§•: í•œêµ­ì–´ íŠ¹í™”, ë¡œì»¬ ì‹¤í–‰ (ë¹ ë¦„)
   - ì†ë„: ~100ms/ë¬¸ì„œ

2ï¸âƒ£ Gemini (API)
   - ëª¨ë¸: text-embedding-004
   - ì°¨ì›: 768
   - íŠ¹ì§•: ì •í™•ì„± ë†’ìŒ, ìºì‹± ì ìš©
   - ì†ë„: 1-2ì´ˆ (ì´ˆíšŒ), <10ms (ìºì‹œ)

[ì£¼ìš” í•¨ìˆ˜]

def get_query_embedding(query, use_gemini_only=False):
    if use_gemini_only:
        â”œâ”€ ìºì‹œ í™•ì¸ (cache/query_embeddings.pkl)
        â”œâ”€ ìºì‹œ ë¯¸ìŠ¤ â†’ Gemini API í˜¸ì¶œ
        â”‚  â””â”€ queryë¥¼ 768ì°¨ì› ë²¡í„°ë¡œ ë³€í™˜
        â””â”€ ìºì‹œì— ì €ì¥ (MD5 í•´ì‹±)
    else:
        â””â”€ SBERTë¡œ ì„ë² ë”© (ìºì‹± ì—†ìŒ, ë¡œì»¬)

[ìºì‹± íš¨ê³¼]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gemini ìºì‹±: 34,893ë°° ì†ë„ í–¥ìƒ   â”‚
â”‚ (ì´ˆíšŒ 1-2ì´ˆ â†’ ìºì‹œ 1-10ms)       â”‚
â”‚ ë¹„ìš©: ì•½ 80% ì ˆê°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[USE_MULTI_EMBEDDING=Trueì¼ ë•Œ]
sparse ê²€ìƒ‰ ê²°ê³¼ + sbert ê²°ê³¼ + gemini ê²°ê³¼ â†’ Hard Voting ìœµí•©
```

---

### 6ï¸âƒ£ retrieval/hybrid_search.py (í•µì‹¬ ê²€ìƒ‰)

```
ì—­í• : Sparse + Dense ê²€ìƒ‰ ë° Hard Voting ìœµí•©
ìœ„ì¹˜: /root/IR/retrieval/hybrid_search.py

[ë©”ì¸ í•¨ìˆ˜]

def run_hybrid_search(
    original_query,          # ì›ë³¸: "ë‚˜ë¬´ì˜ ë¶„ë¥˜ëŠ”?"
    sparse_query,            # Solar í™•ì¥: "ë‚˜ë¬´ëŠ” ë¶„ë¥˜ ì²´ê³„..."
    voting_weights=[5,4,2],  # Hard Voting ê°€ì¤‘ì¹˜
    use_multi_embedding=True,
    top_k_retrieve=50
):

[ì²˜ë¦¬ íë¦„]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ Sparse ê²€ìƒ‰ (BM25)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ es.search_sparse(sparse_q)  â”‚
â”‚ â†’ Top 50 ë¬¸ì„œ + BM25 ì ìˆ˜   â”‚
â”‚                             â”‚
â”‚ ì˜ˆ: [                       â”‚
â”‚   {doc_id: "A", score:0.8}, â”‚
â”‚   {doc_id: "B", score:0.7}, â”‚
â”‚   ...                       â”‚
â”‚ ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ Dense ê²€ìƒ‰ 1 (SBERT)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ embedding_client.sbert(ori) â”‚
â”‚ â†’ Top 50 ë¬¸ì„œ + ìœ ì‚¬ë„      â”‚
â”‚                             â”‚
â”‚ ì˜ˆ: [                       â”‚
â”‚   {doc_id: "C", score:0.75},â”‚
â”‚   {doc_id: "A", score:0.68},â”‚
â”‚   ...                       â”‚
â”‚ ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ Dense ê²€ìƒ‰ 2 (Gemini)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ embedding_client.gemini(ori)â”‚
â”‚ â†’ Top 50 ë¬¸ì„œ + ìœ ì‚¬ë„      â”‚
â”‚                             â”‚
â”‚ ì˜ˆ: [                       â”‚
â”‚   {doc_id: "A", score:0.79},â”‚
â”‚   {doc_id: "C", score:0.71},â”‚
â”‚   ...                       â”‚
â”‚ ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£ Hard Voting ìœµí•©        â”‚
â”‚      [5, 4, 2]              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ê° ë¬¸ì„œë³„ íˆ¬í‘œ ì ìˆ˜ ê³„ì‚°:   â”‚
â”‚                             â”‚
â”‚ doc_A: (1stÃ—5 + 2ndÃ—4 ...  â”‚
â”‚ doc_B: (3rdÃ—5 + 1stÃ—4 ...  â”‚
â”‚ doc_C: (2ndÃ—5 + 1stÃ—4 ...  â”‚
â”‚                             â”‚
â”‚ â†’ ì ìˆ˜ í•©ì‚°ìœ¼ë¡œ ì¬ìˆœìœ„í™”    â”‚
â”‚ â†’ Top 50 ì„ ì •               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£ Reranker (BAAI)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rerank(original_query,     â”‚
â”‚        top_50_docs)        â”‚
â”‚                             â”‚
â”‚ BAAI/bge-reranker-v2-m3ìœ¼ë¡œâ”‚
â”‚ ìµœì¢… ìˆœìœ„ ì¡°ì •             â”‚
â”‚ â†’ Top 50 ì¬ì •ë ¬            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   [ìµœì¢… ê²°ê³¼: Top 50 ë¬¸ì„œ]
```

[Hard Voting ì˜ˆì‹œ]
```
ë¬¸ì„œ A:
  - Sparse ìˆœìœ„: 2ìœ„ (Top 50 ë‚´)
  - SBERT ìˆœìœ„: 1ìœ„ (Top 50 ë‚´)
  - Gemini ìˆœìœ„: 1ìœ„ (Top 50 ë‚´)
  
ì ìˆ˜ = 2Ã—5 + 1Ã—4 + 1Ã—2 = 16ì 

ë¬¸ì„œ B:
  - Sparse ìˆœìœ„: 1ìœ„
  - SBERT ìˆœìœ„: 5ìœ„
  - Gemini ìˆœìœ„: 10ìœ„
  
ì ìˆ˜ = 1Ã—5 + 5Ã—4 + 10Ã—2 = 45ì 

â†’ ë¬¸ì„œ Bê°€ ë” ë†’ì€ ì ìˆ˜ë¡œ ì„ ì •
```

[ê°€ì¤‘ì¹˜ [5,4,2]ì˜ ì˜ë¯¸]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ìœ„ ê°€ì¤‘ì¹˜: 5 (ê°€ì¥ ì¤‘ìš”)    â”‚
â”‚ 2ìœ„ ê°€ì¤‘ì¹˜: 4 (ì¤‘ìš”)         â”‚
â”‚ 3ìœ„ ê°€ì¤‘ì¹˜: 2 (ëœ ì¤‘ìš”)      â”‚
â”‚                              â”‚
â”‚ Phase 4D ìµœì ê°’             â”‚
â”‚ (ì‹¤í—˜ìœ¼ë¡œ ë°œê²¬ë¨)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7ï¸âƒ£ retrieval/es_connector.py (Elasticsearch)

```
ì—­í• : Elasticsearch ì—°ë™
ìœ„ì¹˜: /root/IR/retrieval/es_connector.py

[Elasticsearch ì„œë²„]
- URL: http://localhost:9200
- ë²„ì „: 8.8.0
- ì¸ë±ìŠ¤: test
- ë¬¸ì„œ: 4,272ê°œ

[ì£¼ìš” ë©”ì„œë“œ]

1ï¸âƒ£ search_sparse(query, top_k=50)
   â”œâ”€ BM25 ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ê²€ìƒ‰
   â”œâ”€ query: Solar HyDE í™•ì¥ ì¿¼ë¦¬
   â”œâ”€ ë°˜í™˜: [{doc_id, score}, ...]
   â””â”€ ì†ë„: 100-200ms

2ï¸âƒ£ search_dense(embedding, top_k=50)
   â”œâ”€ ì„ë² ë”© ìœ ì‚¬ë„ ê²€ìƒ‰
   â”œâ”€ embedding: SBERT ë˜ëŠ” Gemini 768ì°¨ì› ë²¡í„°
   â”œâ”€ ë°˜í™˜: [{doc_id, score}, ...]
   â””â”€ ì†ë„: 200-300ms

3ï¸âƒ£ get_document(doc_id)
   â”œâ”€ íŠ¹ì • ë¬¸ì„œì˜ ë‚´ìš© ì¡°íšŒ
   â”œâ”€ í•„ë“œ: docid, content, metadata...
   â””â”€ ì†ë„: 10-50ms

[ì¸ë±ìŠ¤ ë§¤í•‘]
test ì¸ë±ìŠ¤:
â”œâ”€ docid: text (ë¬¸ì„œ ê³ ìœ  ID)
â”œâ”€ content: text (ë¬¸ì„œ ë‚´ìš©)
â”œâ”€ embeddings_sbert: dense_vector (SBERT ì„ë² ë”©)
â”œâ”€ embeddings_gemini: dense_vector (Gemini ì„ë² ë”©)
â””â”€ ê¸°íƒ€: metadata ë“±

[íŠ¹ì§•]
âœ… 4,272ê°œ ë¬¸ì„œ ì¸ë±ì‹± ì™„ë£Œ
âœ… Sparse + Dense ëª¨ë‘ ì§€ì›
âœ… ë¹ ë¥¸ ê²€ìƒ‰ ì„±ëŠ¥ (100-300ms)
```

---

### 8ï¸âƒ£ retrieval/reranker.py (ì¬ìˆœìœ„í™”)

```
ì—­í• : ìµœì¢… ë¬¸ì„œ ìˆœìœ„ ì¡°ì •
ìœ„ì¹˜: /root/IR/retrieval/reranker.py

[Reranker ëª¨ë¸]
- ëª¨ë¸: BAAI/bge-reranker-v2-m3
- ë°©ì‹: CrossEncoder (ì¿¼ë¦¬-ë¬¸ì„œ ìŒ í•™ìŠµ)
- ì…ë ¥: (query, document) ìŒ
- ì¶œë ¥: 0-1 ë²”ìœ„ì˜ ê´€ë ¨ì„± ì ìˆ˜

[ì‘ë™ ë°©ì‹]

def rerank_documents(query, documents):
    1. ì…ë ¥: ì›ë³¸ ì¿¼ë¦¬ + Top 50 ë¬¸ì„œ
    2. ê° (query, document) ìŒë§ˆë‹¤:
       â””â”€ BAAI Reranker ì‹¤í–‰
          â””â”€ ê´€ë ¨ì„± ì ìˆ˜ ê³„ì‚° (0-1)
    3. ê´€ë ¨ì„± ì ìˆ˜ë¡œ ì¬ì •ë ¬
    4. ì¶œë ¥: ì¬ì •ë ¬ëœ Top 50

[ì†ë„]
- Top 50 ë¬¸ì„œ ì¬ìˆœìœ„í™”: 300-500ms

[íŠ¹ì§•]
âœ… CrossEncoder ë°©ì‹ìœ¼ë¡œ ì •í™•í•œ ê´€ë ¨ì„± ê³„ì‚°
âœ… Hard Voting ê²°ê³¼ë¥¼ ìµœì¢… ì •ì œ
âœ… ë…¼ë¬¸/ë²¤ì¹˜ë§ˆí¬ì—ì„œ ê²€ì¦ëœ ëª¨ë¸
```

---

## ğŸ”„ ë°ì´í„° íë¦„ ìƒì„¸ ì˜ˆì‹œ

```
ì…ë ¥: "DNAì˜ êµ¬ì¡°ëŠ”?"
  â†“
[llm_client]
  - Gemini: "ê³¼í•™ ì§ˆë¬¸" â†’ tool_calls ìƒì„±
  â†“
[solar_client - HyDE]
  - Solar: "DNAì˜ êµ¬ì¡°ëŠ”?" 
           â†’ "DNAëŠ” ë‰´í´ë ˆì˜¤íƒ€ì´ë“œë¡œ êµ¬ì„±ëœ ì´ì¤‘ë‚˜ì„  êµ¬ì¡°..."
  â†“
[hybrid_search]
  â”Œâ”€ [sparse] BM25: "DNA" "ì´ì¤‘ë‚˜ì„ " â†’ [doc1, doc5, ...]
  â”œâ”€ [dense-sbert] ì„ë² ë”© ìœ ì‚¬ë„ â†’ [doc2, doc1, ...]
  â””â”€ [dense-gemini] ì„ë² ë”© ìœ ì‚¬ë„ â†’ [doc1, doc3, ...]
     
  Hard Voting [5,4,2]:
  - doc1: 1stÃ—5 + 2ndÃ—4 + 1stÃ—2 = 16
  - doc2: 5thÃ—5 + 2ndÃ—4 + 3rdÃ—2 = 17  â† 1ìœ„
  - doc5: 3rdÃ—5 + 10thÃ—4 = 55
  
  Reranker: ìµœì¢… ì •ë ¬ â†’ [doc2, doc1, doc3, doc5, ...]
  â†“
[es_connector - get_document]
  - doc2 ë‚´ìš©: "DNAëŠ” ë””ì˜¥ì‹œë¦¬ë³´í•µì‚°ì˜ ì•½ìë¡œ..."
  - doc1 ë‚´ìš©: "DNA ë¶„ìëŠ”..."
  - doc3 ë‚´ìš©: "ìœ ì „ì ë°œí˜„ì—ì„œ..."
  â†“
[solar_client - generate_answer]
  - ì…ë ¥: "DNAì˜ êµ¬ì¡°ëŠ”?" + ìœ„ 3ê°œ ë¬¸ì„œ
  - Solar: "DNAëŠ” ë””ì˜¥ì‹œë¦¬ë³´í•µì‚°ì˜ ì•½ìë¡œ, 
           ë‰´í´ë ˆì˜¤íƒ€ì´ë“œ 4ê°œì˜ ì—¼ê¸°(A, T, G, C)ë¡œ
           êµ¬ì„±ëœ ì´ì¤‘ë‚˜ì„  êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤..."
  â†“
ì¶œë ¥: {
  "eval_id": 123,
  "standalone_query": "DNAì˜ êµ¬ì¡°ëŠ”?",
  "topk": ["doc2", "doc1", "doc3", "doc5", "doc9"],
  "answer": "DNAëŠ”..."
}
```

---

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” ìš”ì•½

| ìµœì í™” | íš¨ê³¼ | êµ¬í˜„ ìœ„ì¹˜ |
|--------|------|----------|
| **Solar HyDE ìºì‹±** | 80% ë¹„ìš© ì ˆê° | solar_client.py |
| **Gemini ì„ë² ë”© ìºì‹±** | 34,893ë°° ì†ë„ í–¥ìƒ | embedding_client.py |
| **ë©€í‹° ì„ë² ë”©** | ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ | hybrid_search.py |
| **Hard Voting [5,4,2]** | ìµœì  ê°€ì¤‘ì¹˜ | hybrid_search.py |
| **Reranker** | ìµœì¢… ìˆœìœ„ ì •ì œ | reranker.py |

---

**í˜„ì¬ ìµœê³  ì„±ëŠ¥**: Phase 4D (MAP 0.8424)  
**ê°€ì¥ ìì£¼ ìˆ˜ì •í•˜ëŠ” íŒŒì¼**: eval_rag.py (ì„¤ì •ê°’)  
**ê°€ì¥ ì¤‘ìš”í•œ ê¸°ëŠ¥**: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ + Hard Voting ìœµí•©
