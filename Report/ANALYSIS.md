# Phase 4D vs Phase 6B-1 원인 분석

## 핵심 발견

### 1. 게이팅 정책의 문제

**Phase 6B-1 (게이팅 적용) 점수:**
- MAP: 0.8083 (-3.41% vs Phase 4D)
- MRR: 0.8106 (-4.64% vs Phase 4D)

**원인 분석:**
```
평가 데이터 분포:
├─ 과학 질문: 84% (추정 184개)
│  └─ 실제 검색/랭킹으로 MAP 계산
├─ 비과학 질문: 16% (추정 35개)
│  └─ topk=[] 정책 적용 -> 자동으로 MAP=1.0
└─ 결론: 게이팅이 과도하거나 비과학 분류 오류
```

### 2. 리더보드와 개발 환경의 차이

**가능한 원인들:**
1. **LLM 분류기의 일관성 문제**
   - Gemini API 응답이 비결정적일 수 있음
   - tool_calls 판단 기준이 리더보드와 다를 수 있음

2. **데이터셋 차이**
   - 개발 환경의 평가셋과 리더보드 평가셋이 다를 수 있음
   - 비과학 질문 비율이 다를 수 있음

3. **게이팅 정책 방향성 오류**
   - 리더보드에서는 **모든 질문에 검색 결과 반환**이 필요할 수 있음
   - topk=[] 정책이 MAP을 떨어뜨리는 역효과 발생

### 3. Solar Pro 2 고정 조건에서의 최적화

**현재 상태:**
- Solar Pro 2 HyDE: 모든 설정에서 동일
- 캐싱: 쿼리 임베딩 & HyDE 생성 캐싱 적용
- 성능: 첫 실행 이후 거의 0비용으로 재평가 가능

**최적화 변수:**
1. **TOP_K_RETRIEVE**: 50 → 60, 70 테스트
2. **VOTING_WEIGHTS**: [5,4,2] 근처 미세 조정
3. **게이팅 정책**: ON/OFF 또는 더 정교한 기준

## 현재 테스트 전략

### Phase 4D-NoGating (완료)
```
설정: [5,4,2], TopK=50, 게이팅 OFF
목표: 기준선 (0.8424) 복구 확인
예상: 0.8424 근처 (모든 질문 검색)
상태: 평가 완료, 리더보드 대기
```

### Phase 4D-TopK60 (진행 중)
```
설정: [5,4,2], TopK=60, 게이팅 ON
목표: 더 넓은 후보군으로 개선
가설: 상위 50개에 없던 좋은 문서가 51-60에 있을 가능성
예상: +0.5-1% 개선
기대 점수: 0.845-0.852
```

### Phase 4D-TopK70
```
설정: [5,4,2], TopK=70, 게이팅 ON
목표: 최대 TOP_K 테스트
가설: 더욱 큰 개선 가능
예상: +0.5-1.5% 개선 또는 과도로 인한 하락
```

### Phase 4D-Weight[5,5,2]
```
설정: [5,5,2], TopK=50, 게이팅 ON
목표: 가중치 미세 조정
가설: 2위 문서가 중요할 수 있음
예상: ±0.5% (양쪽 모두 가능)
```

## 예상 시나리오

### 시나리오 1: 게이팅이 주범 (확률 60%)
- Phase 4D-NoGating: 0.84-0.845 (Phase 4D와 비슷)
- Phase 4D-TopK60: 0.84-0.845 (개선 없음)
- **결론**: 게이팅 정책 제거 권장

### 시나리오 2: TOP_K가 병목 (확률 30%)
- Phase 4D-NoGating: 0.8083 (낮은 상태 유지)
- Phase 4D-TopK60: 0.84-0.85 (유의미한 개선)
- **결론**: TOP_K 증가가 핵심 해결책

### 시나리오 3: 복합 문제 (확률 10%)
- Phase 4D-NoGating: 0.815
- Phase 4D-TopK60: 0.835
- **결론**: 게이팅 제거 + TOP_K 증가 조합 필요

## 최종 목표

### 단기 (현재 테스트)
- 0.84+ 달성 (Phase 4D 기준선 복구)
- 최적 설정 결정

### 중기 (다음 최적화)
- 0.85+ 달성 (추가 1% 개선)
- VOTING_WEIGHTS 미세 조정

### 장기 (추가 탐색)
- 0.86+ 달성 (더블 임베딩 최적화)
- 모델 앙상블 재구성

## 액션 아이템

1. ✅ Phase 4D-NoGating 완료 → 리더보드 제출 대기
2. ⏳ Phase 4D-TopK60 진행 중 (25-30분 소요)
3. ⏭️ 결과 분석 후 다음 설정 결정
4. ⏭️ 최고 성능 설정으로 최종 평가 후 제출
