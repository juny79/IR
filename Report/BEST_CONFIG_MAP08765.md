# Best Snapshot (MAP 0.8765 / MRR 0.8803)

- Date: 2025-12-23
- Repo/Branch: `juny79/IR` / `main`
- Commit: `0d4ea31099a64f3a7e74dafdd59fdc9f71b739c2`

## Submitted File (확정)
- File: `submission.csv`
- Rows: 220 (parse_errors=0)
- SHA256: `a17ce0a728424d4a1515f8aed39be8b4c2732a284be17999d6983bc339ce86e2`
- Backup identical: `submission_27.csv` (sha256 동일)
- `topk=[]` (검색 스킵) eval_id: 21개
  - [2, 32, 57, 64, 67, 83, 90, 94, 103, 108, 218, 220, 222, 227, 229, 245, 247, 261, 276, 283, 301]
- Source of truth snapshot: `submission_snapshot.json` (generated by `snapshot_submission.py`)

## Core Pipeline Settings (코드 기준)
These are the effective settings in [eval_rag.py](eval_rag.py).

### Retrieval + Fusion
- TopK retrieve (`top_k_retrieve`): 50
- Fusion algorithm: Hard Voting (`USE_RRF=False`)
- Voting weights: [5, 4, 2]
- Embeddings: Multi-embedding enabled (`USE_MULTI_EMBEDDING=True`)
  - Dense #1: SBERT (`embeddings_sbert`)
  - Dense #2: Gemini (`embeddings_gemini`)
- Sparse: BM25 on `content` with HyDE-expanded query

### Query Strategy (drift 억제 핵심)
- `original_user_query`: 원문 사용자 질문
- Dense query: `original_user_query` (LLM rewrite 영향 최소화)
- Reranker query: `original_user_query`
- Sparse query: `standalone_query + HyDE` (재현율 확보)

### Reranker
- Model: `BAAI/bge-reranker-v2-m3`
- Candidate pool: 50 docids (fusion 결과)
- Returns: top 5
- Doc truncation: 512 chars per doc pair (speed + robustness)

### Answering
- Context: top-3 docs concatenated
- Answer LLM: Solar (`solar_client.generate_answer`)

## “Gating” / Skip Policy (실제로 MAP 올린 포인트)
- 구현은 [models/solar_client.py](models/solar_client.py) `analyze_query_and_hyde()` 기반
- 개념은 **"과학/비과학"이 아니라 "코퍼스 검색이 필요한 지식/설명 질문 vs 순수 잡담"**
- 결과적으로 순수 잡담만 `topk=[]` 처리 (21개)
- 파싱 실패 시에도 과도 스킵을 피하도록 보수적으로 동작(대부분 검색 수행)

## Why this likely scored best (핵심 기여 요인)
1. **Over-skipping 제거**: 정보성 질문(과학 외 영역 포함)을 검색 대상으로 넓혀 MAP 손실을 막음 (empty topk 21로 축소)
2. **Query drift 차단**: dense/reranker는 원문 질문 유지 → 의미 변형으로 인한 오검색 감소
3. **HyDE는 Sparse에만 사용**: BM25 recall을 올리되 dense/리랭커 정밀도는 원문으로 유지
4. **SBERT+Gemini 멀티 임베딩 + Hard Voting [5,4,2]**: 서로 다른 신호의 상보성을 가중치로 안정화
5. **Cross-encoder rerank로 최종 Top-5 정밀도 확보**: fusion 후보 50에서 bge-reranker로 재정렬

## Repro
- Generate submission:
  - `python3 main.py`
- Sanity checks:
  - `python3 snapshot_submission.py` → `submission_snapshot.json`
  - `python3 compare_gating_vs_submission.py`

## Notes / Guardrails
- 이 스냅샷은 "현재 최고점 기준선"이므로, 이후 튜닝 시에는 반드시 아래를 같이 기록하세요:
  - `submission.csv` sha256
  - `eval_rag.py` 상수값 변경 diff
  - empty topk 개수/ID 변화
