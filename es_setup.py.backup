import os
import json
import urllib3
from elasticsearch import Elasticsearch, helpers
from models.embedding_client import embedding_client

# 보안 경고 끄기
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# [.env] 의존성 제거: 비밀번호를 직접 입력했습니다.
es = Elasticsearch(
    "https://localhost:9200",
    basic_auth=("elastic", "JeCGV5SU5*XAYqHkxPFi"), 
    verify_certs=False,
    ssl_show_warn=False
)

def create_index():
    index_name = "test"
    settings = {
        "analysis": {
            "analyzer": {
                "nori": {
                    "type": "custom",
                    "tokenizer": "nori_tokenizer",
                    "decompound_mode": "mixed",
                    "filter": ["nori_posfilter"]
                }
            }
        }
    }
    mappings = {
        "properties": {
            "docid": {"type": "keyword"},
            "content": {"type": "text", "analyzer": "nori"},
            "embeddings_sbert": {"type": "dense_vector", "dims": 768, "index": True, "similarity": "l2_norm"}
        }
    }
    
    if es.indices.exists(index=index_name):
        es.indices.delete(index=index_name)
    es.indices.create(index=index_name, settings=settings, mappings=mappings)
    print(f"Index '{index_name}' created successfully.")

def index_documents(file_path):
    print(f"Reading documents from {file_path}...")
    with open(file_path, "r", encoding="utf-8") as f:
        docs = [json.loads(line) for line in f]

    actions = []
    print(f"Start embedding and indexing {len(docs)} documents...")
    
    for i, doc in enumerate(docs):
        doc_id = doc.get("documentID") or doc.get("docid")
        content = doc["content"]
        
        # 임베딩 생성
        embedding = embedding_client.get_embedding(content, model_name="sbert").tolist()
        
        doc["embeddings_sbert"] = embedding
        doc["docid"] = doc_id
        
        actions.append({"_index": "test", "_source": doc})
        
        if (i+1) % 100 == 0:
            print(f"Processed {i+1} documents...")

    helpers.bulk(es, actions)
    print("Bulk indexing completed.")

if __name__ == "__main__":
    create_index()
    index_documents("./data/documents.jsonl")
